---
import Layout from "../../layouts/Layout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import CTAButton from "../../components/CTAButton.astro";
const base = import.meta.env.BASE_URL;

type ServiceEntry = CollectionEntry<"services">;
type AreaEntry = CollectionEntry<"areas">;

export async function getStaticPaths() {
  const services = await getCollection("services");
  return services.map((entry: ServiceEntry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props as { entry: ServiceEntry };
const { title, description, heroTitle, heroSubtitle, areas, faqs } = entry.data;

const canonical = `https://www.gccmelbourne.com.au/services/${entry.slug}`;

// Areas that include THIS service slug in their frontmatter `services: [...]`
const allAreas = await getCollection("areas");
const areasForThisService: AreaEntry[] = allAreas
  .filter((a) => (a.data.services ?? []).includes(entry.slug))
  .slice(0, 12);

const serviceJsonLd = {
  "@context": "https://schema.org",
  "@type": "Service",
  name: heroTitle ?? title,
  description,
  provider: {
    "@type": "LocalBusiness",
    name: "GCC Melbourne",
    url: "https://www.gccmelbourne.com.au",
    telephone: "+61422780703",
    areaServed: "Melbourne, VIC",
  },
  areaServed: areas?.length ? areas : ["Melbourne, VIC"],
  url: canonical,
};

const faqJsonLd =
  faqs?.length
    ? {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        mainEntity: faqs.map((f: { q: string; a: string }) => ({
          "@type": "Question",
          name: f.q,
          acceptedAnswer: { "@type": "Answer", text: f.a },
        })),
      }
    : null;

const { Content } = await entry.render();
---

<Layout title={`${heroTitle ?? title} | GCC Melbourne`} description={description}>
  <Fragment slot="head">
    <link rel="canonical" href={canonical} />
    <script type="application/ld+json">{JSON.stringify(serviceJsonLd)}</script>
    {faqJsonLd && <script type="application/ld+json">{JSON.stringify(faqJsonLd)}</script>}
  </Fragment>

  <main class="mx-auto max-w-6xl px-6 py-12">
    <!-- HERO -->
<section class="gcc-hero-light rounded-3xl p-8 md:p-10">
  <p class="text-sm font-semibold tracking-wide" style="color: var(--brand-teal);">
    GCC Melbourne
  </p>

  <h1 class="mt-2 text-4xl font-bold tracking-tight md:text-5xl">
    {heroTitle ?? title}
  </h1>

  {heroSubtitle && (
    <p class="mt-4 max-w-3xl text-lg gcc-muted">
      {heroSubtitle}
    </p>
  )}

  <div class="mt-6 flex flex-wrap gap-3">
    <CTAButton
      href={`${base}/contact`}
      label="Get a Quote"
      variant="primary"
      icon="quote"
    />
    <CTAButton
      href="tel:+61422780703"
      label="Call Us"
      variant="outline"
      icon="phone"
    />
  </div>

  {areas?.length ? (
    <p class="mt-6 text-sm gcc-muted">
      Servicing: <span class="font-semibold" style="color: var(--text-main);">
        {areas.join(" • ")}
      </span>
    </p>
  ) : null}
</section>


    <!-- CONTENT -->
    <article class="prose prose-slate mt-10 max-w-none">
      <Content />
    </article>

    <!-- FAQ (visible section matches schema) -->
    {faqs?.length ? (
      <section class="mt-14">
        <h2 class="text-2xl font-bold">FAQ</h2>
        <div class="mt-6 space-y-3">
          {faqs.map((f: { q: string; a: string }) => (
            <details class="rounded-2xl border border-slate-200 p-5">
              <summary class="cursor-pointer font-semibold">{f.q}</summary>
              <p class="mt-3 text-slate-700">{f.a}</p>
            </details>
          ))}
        </div>
      </section>
    ) : null}

    <!-- AREAS WE SERVE (internal linking boost) -->
    {areasForThisService.length ? (
      <section class="mt-14">
        <h2 class="text-2xl font-bold">Areas we serve for {title}</h2>
        <p class="mt-2 text-slate-700">
          We provide {title.toLowerCase()} across these Melbourne areas:
        </p>

        <div class="mt-6 grid gap-4 md:grid-cols-3">
          {areasForThisService.map((a) => (
            <a
              href={`${base}/areas/${a.slug}`}
              class="rounded-2xl border border-slate-200 p-6 hover:border-slate-300"
            >
              <div class="font-semibold">{a.data.suburb}</div>
              <p class="mt-2 text-sm text-slate-600">{a.data.description}</p>
            </a>
          ))}
        </div>
      </section>
    ) : null}

    <!-- FINAL CTA -->
    <section class="mt-14 rounded-3xl bg-slate-900 p-8 text-white">
      <h2 class="text-2xl font-bold">Get a quote today</h2>
      <p class="mt-2 text-white/80">
        Tell us your site size, frequency, and preferred schedule — we’ll reply with a clear scope.
      </p>
<div class="mt-6 flex flex-wrap gap-3">
  <CTAButton href={`${base}/contact`} label="Get a Quote" variant="primary" icon="quote" />
<CTAButton href="tel:+61422780703" label="Call Us" variant="outline" icon="phone" tone="dark" />
</div>
    </section>
  </main>
</Layout>
